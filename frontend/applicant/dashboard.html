<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Korea Working Visa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-passport text-2xl"></i>
                <h1 class="text-xl font-bold">My Dashboard</h1>
            </div>
            <div class="flex items-center gap-4">
                <select id="langSelector" onchange="changeLanguage(this.value)" class="bg-white/20 text-white border-0 rounded px-2 py-1 text-sm">
                    <option value="en">EN</option>
                    <option value="ko">한국어</option>
                    <option value="vi">VI</option>
                    <option value="th">TH</option>
                    <option value="tl">TL</option>
                </select>
                <span id="userName" class="text-sm"></span>
                <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-2xl">
        <!-- Application Status Card -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-4 text-white">
                <h2 class="text-lg font-bold" data-i18n="applicationStatus">Application Status</h2>
            </div>
            <div id="applicationCard" class="p-6">
                <div class="text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p data-i18n="loading">Loading...</p>
                </div>
            </div>
        </div>

        <!-- New Application Form -->
        <div id="newApplicationSection" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
            <div class="bg-gradient-to-r from-green-500 to-blue-500 p-4 text-white">
                <h2 class="text-lg font-bold" data-i18n="newApplication">New Visa Application</h2>
            </div>
            <form id="applicationForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="nationality">Nationality</label>
                        <input type="text" id="nationality" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="passportNumber">Passport Number</label>
                        <input type="text" id="passportNumber" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="birthDate">Birth Date</label>
                        <input type="date" id="birthDate" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="gender">Gender</label>
                        <select id="gender" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="male" data-i18n="male">Male</option>
                            <option value="female" data-i18n="female">Female</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="visaType">Visa Type</label>
                    <select id="visaType" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="E8">E-8 (Seasonal Worker)</option>
                        <option value="E9">E-9 (Non-professional)</option>
                        <option value="H2">H-2 (Working Visit)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="employerName">Employer Name</label>
                    <input type="text" id="employerName" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                    <i class="fas fa-paper-plane mr-2"></i> <span data-i18n="submitApplication">Submit Application</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/kwv';
        let currentUser = null;

        const translations = {
            en: { applicationStatus: 'Application Status', loading: 'Loading...', newApplication: 'New Visa Application', nationality: 'Nationality', passportNumber: 'Passport Number', birthDate: 'Birth Date', gender: 'Gender', male: 'Male', female: 'Female', visaType: 'Visa Type', employerName: 'Employer Name', submitApplication: 'Submit Application', noApplication: 'No application found', startApplication: 'Start New Application', pending: 'Pending Review', processing: 'Processing', approved: 'Approved', rejected: 'Rejected' },
            ko: { applicationStatus: '신청 현황', loading: '로딩 중...', newApplication: '새 비자 신청', nationality: '국적', passportNumber: '여권번호', birthDate: '생년월일', gender: '성별', male: '남성', female: '여성', visaType: '비자 유형', employerName: '고용주', submitApplication: '신청서 제출', noApplication: '신청 내역이 없습니다', startApplication: '새 신청 시작', pending: '심사 대기중', processing: '처리중', approved: '승인됨', rejected: '거절됨' },
            vi: { applicationStatus: 'Trạng Thái Đơn', loading: 'Đang tải...', newApplication: 'Đơn Visa Mới' },
            th: { applicationStatus: 'สถานะการสมัคร', loading: 'กำลังโหลด...', newApplication: 'สมัครวีซ่าใหม่' },
            tl: { applicationStatus: 'Status ng Application', loading: 'Naglo-load...', newApplication: 'Bagong Visa Application' }
        };

        let currentLang = localStorage.getItem('kwv_language') || 'en';

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('kwv_language', lang);
            applyTranslations();
        }

        function applyTranslations() {
            const t = translations[currentLang] || translations.en;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            document.getElementById('langSelector').value = currentLang;
        }

        function getToken() { return localStorage.getItem('kwv_token'); }

        function logout() {
            localStorage.removeItem('kwv_token');
            localStorage.removeItem('kwv_user');
            window.location.href = '/kwv-login.html';
        }

        function getStatusInfo(status) {
            const t = translations[currentLang] || translations.en;
            const info = {
                pending: { text: t.pending, color: 'yellow', icon: 'clock' },
                processing: { text: t.processing, color: 'blue', icon: 'spinner fa-spin' },
                approved: { text: t.approved, color: 'green', icon: 'check-circle' },
                rejected: { text: t.rejected, color: 'red', icon: 'times-circle' }
            };
            return info[status] || info.pending;
        }

        async function loadApplication() {
            const t = translations[currentLang] || translations.en;
            const card = document.getElementById('applicationCard');

            try {
                const res = await fetch(`${API_BASE}/my/application`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();

                if (!data.application) {
                    card.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-file-alt text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 mb-4">${t.noApplication}</p>
                            <button onclick="showApplicationForm()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-plus mr-2"></i>${t.startApplication}
                            </button>
                        </div>
                    `;
                    return;
                }

                const app = data.application;
                const status = getStatusInfo(app.status);

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-${status.color}-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-${status.icon} text-2xl text-${status.color}-600"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Status</p>
                                <p class="text-xl font-bold text-${status.color}-600">${status.text}</p>
                            </div>
                        </div>
                        <span class="bg-gray-100 px-3 py-1 rounded-full text-sm">${app.visa_type}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-500">Nationality:</span> ${app.nationality}</div>
                        <div><span class="text-gray-500">Passport:</span> ${app.passport_number}</div>
                        <div><span class="text-gray-500">Applied:</span> ${new Date(app.created_at).toLocaleDateString()}</div>
                        <div><span class="text-gray-500">Updated:</span> ${app.updated_at ? new Date(app.updated_at).toLocaleDateString() : '-'}</div>
                    </div>
                `;
            } catch (error) {
                card.innerHTML = `<div class="text-center text-red-500">Error loading application</div>`;
            }
        }

        function showApplicationForm() {
            document.getElementById('newApplicationSection').classList.remove('hidden');
        }

        document.getElementById('applicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                const res = await fetch(`${API_BASE}/my/application`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nationality: document.getElementById('nationality').value,
                        passport_number: document.getElementById('passportNumber').value,
                        birth_date: document.getElementById('birthDate').value,
                        gender: document.getElementById('gender').value,
                        visa_type: document.getElementById('visaType').value,
                        employer_name: document.getElementById('employerName').value
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Failed');
                }

                document.getElementById('newApplicationSection').classList.add('hidden');
                loadApplication();
            } catch (error) {
                alert(error.message);
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            const token = getToken();
            const user = localStorage.getItem('kwv_user');

            if (!token || !user) {
                window.location.href = '/kwv-login.html';
                return;
            }

            currentUser = JSON.parse(user);

            if (currentUser.user_type === 'admin') {
                window.location.href = '/admin/dashboard.html';
                return;
            }

            document.getElementById('userName').textContent = currentUser.name;
            applyTranslations();
            loadApplication();
        });
    </script>
</body>
</html>
